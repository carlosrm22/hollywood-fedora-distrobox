#!/usr/bin/env bash
set -euo pipefail

mode="${1:-}"
if [[ -z "$mode" ]]; then
  echo "usage: fondo-pane-rotator <cpu|net|disk|cores|profile|fx>"
  exit 2
fi

widget_dir="${FONDO_WIDGET_DIR:-$HOME/.local/share/fondo/widgets}"

default_duration=14
case "$mode" in
  cpu) default_duration="${FONDO_CPU_ROTATE_SECS:-10}" ;;
  net) default_duration="${FONDO_NET_ROTATE_SECS:-10}" ;;
  disk) default_duration="${FONDO_DISK_ROTATE_SECS:-12}" ;;
  cores) default_duration="${FONDO_CORES_ROTATE_SECS:-10}" ;;
  profile) default_duration="${FONDO_PROFILE_ROTATE_SECS:-14}" ;;
  fx) default_duration="${FONDO_FX_ROTATE_SECS:-12}" ;;
  *)
    echo "invalid mode: $mode"
    exit 2
    ;;
esac

run_for() {
  local seconds="$1"
  local cmd="$2"
  if command -v timeout >/dev/null 2>&1; then
    timeout --foreground "$seconds" bash -lc "$cmd" || true
  else
    bash -lc "$cmd" || true
  fi
}

has_widget() {
  local name="$1"
  local path="$widget_dir/$name"
  [[ -x "$path" ]] || return 1
  "$path" --check >/dev/null 2>&1
}

map_ok() {
  local min_cols="${FONDO_MAP_MIN_COLS:-68}"
  local min_lines="${FONDO_MAP_MIN_LINES:-16}"
  (( cols >= min_cols && lines >= min_lines ))
}

mplayer_ok() {
  local min_cols="${FONDO_MPLAYER_MIN_COLS:-88}"
  local min_lines="${FONDO_MPLAYER_MIN_LINES:-22}"
  (( cols >= min_cols && lines >= min_lines ))
}

while true; do
  cmds=()
  cols=$(tput cols 2>/dev/null || echo 80)
  lines=$(tput lines 2>/dev/null || echo 24)

  case "$mode" in
    cpu)
      # Always-safe options first for compact panes.
      command -v procs >/dev/null 2>&1 && cmds+=("procs --watch --color always --theme dark")
      has_widget hexdump && cmds+=("$widget_dir/hexdump")
      has_widget logs && cmds+=("$widget_dir/logs")

      # Only run full-screen TUIs when pane dimensions are adequate.
      if (( cols >= 72 && lines >= 16 )); then
        command -v htop >/dev/null 2>&1 && cmds+=("htop")
      fi
      if (( cols >= 95 && lines >= 24 )); then
        command -v btop >/dev/null 2>&1 && cmds+=("btop")
        command -v atop >/dev/null 2>&1 && cmds+=("atop")
      fi
      ;;
    net)
      # Barracuda readings with strong presence, plus live network tools.
      if command -v upsilon-readings >/dev/null 2>&1; then
        cmds+=(
          "upsilon-readings" "upsilon-readings" "upsilon-readings"
          "upsilon-readings" "upsilon-readings" "upsilon-readings"
        )
      fi
      command -v bmon >/dev/null 2>&1 && cmds+=("bmon --show-all")
      has_widget speedometer && cmds+=("$widget_dir/speedometer")
      cmds+=("watch -n 1 -c \"cat /proc/net/dev\"")
      ;;
    disk)
      command -v iostat >/dev/null 2>&1 && cmds+=("watch -n 2 -c 'iostat -dx 1 1'")
      command -v duf >/dev/null 2>&1 && cmds+=("watch -n 2 -c 'duf --theme ansi'")
      has_widget tree && cmds+=("$widget_dir/tree")
      has_widget stat && cmds+=("$widget_dir/stat")
      has_widget logs && cmds+=("$widget_dir/logs")
      ;;
    cores)
      command -v mpstat >/dev/null 2>&1 && cmds+=("watch -n 2 -c 'mpstat -P ALL 1 1'")
      cmds+=("watch -n 1 -c \"grep -E '^cpu' /proc/stat | head -n 16\"")
      if (( cols >= 72 && lines >= 16 )); then
        command -v htop >/dev/null 2>&1 && cmds+=("htop")
      fi
      ;;
    profile)
      command -v fastfetch >/dev/null 2>&1 && cmds+=("watch -n 8 -c 'fastfetch --pipe false --bright-color true'")
      has_widget man && cmds+=("$widget_dir/man")
      has_widget code && cmds+=("$widget_dir/code")
      has_widget jp2a && cmds+=("$widget_dir/jp2a")
      # Show map at medium frequency, but only when pane size is good.
      if has_widget map && map_ok && (( RANDOM % 100 < 55 )); then
        cmds+=("$widget_dir/map")
      fi
      # Reduce flicker: rare mplayer, and only with large panes.
      if has_widget mplayer && mplayer_ok && (( RANDOM % 100 < 6 )); then
        cmds+=("$widget_dir/mplayer")
      fi
      ;;
    fx)
      # Prioritize Barracuda and map feed, keep cmatrix as occasional effect.
      if command -v upsilon-readings >/dev/null 2>&1; then
        cmds+=(
          "upsilon-readings" "upsilon-readings" "upsilon-readings"
          "upsilon-readings" "upsilon-readings" "upsilon-readings"
          "upsilon-readings"
        )
      fi
      if has_widget map && map_ok && (( RANDOM % 100 < 38 )); then
        cmds+=("$widget_dir/map")
      fi
      command -v cmatrix >/dev/null 2>&1 && cmds+=("cmatrix -ab -u 10")
      has_widget apg && cmds+=("$widget_dir/apg")
      has_widget sshart && cmds+=("$widget_dir/sshart")
      has_widget jp2a && cmds+=("$widget_dir/jp2a")
      # Reduce flicker: very rare mplayer, and only with large panes.
      if has_widget mplayer && mplayer_ok && (( RANDOM % 100 < 3 )); then
        cmds+=("$widget_dir/mplayer")
      fi
      ;;
  esac

  if [[ "${#cmds[@]}" -eq 0 ]]; then
    echo "No runnable commands for mode=$mode"
    sleep 2
    continue
  fi

  # Weighted random: bias to front of list for readability.
  pick_idx=$((RANDOM % ${#cmds[@]}))
  if (( RANDOM % 100 < 55 )); then
    half=$(( (${#cmds[@]} + 1) / 2 ))
    pick_idx=$((RANDOM % half))
  fi
  pick="${cmds[$pick_idx]}"

  run_duration="$default_duration"
  [[ "$pick" == *"mplayer"* ]] && run_duration="${FONDO_MPLAYER_MAX_SECS:-5}"

  clear
  printf '\033[1;96m[%s %sx%s]\033[0m \033[1;92m%s\033[0m\n\n' "$mode" "$cols" "$lines" "$pick"
  run_for "$run_duration" "TERM=tmux-256color COLORTERM=truecolor $pick"
  sleep 0.2
done
