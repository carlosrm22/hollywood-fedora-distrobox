#!/usr/bin/env bash
set -euo pipefail

WIDGET_DIR="${FONDO_WIDGET_DIR:-$HOME/.local/share/fondo/widgets}"
DURATION="${FONDO_WIDGET_DURATION:-18}"

if [[ ! -d "$WIDGET_DIR" ]]; then
  echo "Widget dir missing: $WIDGET_DIR"
  exit 1
fi

list_available() {
  local w
  for w in "$WIDGET_DIR"/*; do
    [[ -x "$w" ]] || continue
    "$w" --check >/dev/null 2>&1 && basename "$w"
  done
}

if [[ "${1:-}" == "--list" ]]; then
  list_available | sort
  exit 0
fi

mapfile -t widgets < <(list_available)
if [[ "${#widgets[@]}" -eq 0 ]]; then
  echo "No available hollywood-style widgets (missing dependencies)."
  echo "Tip: install extras like apg, atop, bmon, ccze, jp2a, speedometer, mplayer"
  exit 1
fi

has_widget_name() {
  local target="$1"
  local w
  for w in "${widgets[@]}"; do
    [[ "$w" == "$target" ]] && return 0
  done
  return 1
}

map_ok() {
  local cols lines
  cols=$(tput cols 2>/dev/null || echo 80)
  lines=$(tput lines 2>/dev/null || echo 24)
  local min_cols="${FONDO_MAP_MIN_COLS:-68}"
  local min_lines="${FONDO_MAP_MIN_LINES:-16}"
  (( cols >= min_cols && lines >= min_lines ))
}

iter=0
while true; do
  iter=$((iter + 1))
  if has_widget_name "map" && map_ok && (( iter % 8 == 0 )); then
    pick="map"
  else
    pick="${widgets[RANDOM % ${#widgets[@]}]}"
    # Reduce flicker from ASCII video by deprioritizing mplayer.
    if [[ "$pick" == "mplayer" ]] && (( RANDOM % 100 < 97 )); then
      for _ in 1 2 3 4 5; do
        alt="${widgets[RANDOM % ${#widgets[@]}]}"
        if [[ "$alt" != "mplayer" ]]; then
          pick="$alt"
          break
        fi
      done
    fi
  fi
  printf '\033[1;96m[%s]\033[0m widget: \033[1;92m%s\033[0m\n\n' "$(date +%H:%M:%S)" "$pick"
  if command -v timeout >/dev/null 2>&1; then
    timeout --foreground "$DURATION" "$WIDGET_DIR/$pick" || true
  else
    "$WIDGET_DIR/$pick" || true
  fi
  clear
done
