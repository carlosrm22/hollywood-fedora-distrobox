#!/usr/bin/env bash
set -euo pipefail

session="fondo"
motion="${FONDO_MOTION:-1}"
interval="${FONDO_LAYOUT_INTERVAL:-8}"
missing=()
for cmd in tmux btop procs duf fastfetch cmatrix watch; do
  command -v "$cmd" >/dev/null 2>&1 || missing+=("$cmd")
done

if [ "${#missing[@]}" -gt 0 ]; then
  printf "Missing commands: %s\n" "${missing[*]}"
  exit 1
fi

if tmux has-session -t "$session" 2>/dev/null; then
  exec tmux attach -t "$session"
fi

if [ -t 1 ] && command -v figlet >/dev/null 2>&1; then
  clear
  if command -v lolcat >/dev/null 2>&1; then
    figlet -f small HOLLYWOOD | lolcat
  else
    figlet -f small HOLLYWOOD
  fi
  sleep 0.7
fi

win_id="$(tmux new-session -d -P -F "#{window_id}" -s "$session" "TERM=tmux-256color COLORTERM=truecolor btop")"

tmux set-option -t "$session" -gq default-terminal "tmux-256color"
tmux set-option -t "$session" -gq status on
tmux set-option -t "$session" -gq status-interval 1
tmux set-option -t "$session" -gq status-style "bg=colour17,fg=colour45"
tmux set-option -t "$session" -gq status-left-length 48
tmux set-option -t "$session" -gq status-right-length 130
tmux set-option -t "$session" -gq status-left "#[fg=colour51,bold] HOLLYWOOD #[fg=colour39]| #[fg=colour45]#S "
tmux set-option -t "$session" -gq status-right "#[fg=colour45]%Y-%m-%d #[fg=colour51]%H:%M:%S #[fg=colour39]| m:${motion} i:${interval}s #[fg=colour39]| C-b q exit / l layout / r rotate"
tmux set-option -t "$session" -gq pane-border-status top
tmux set-option -t "$session" -gq pane-border-format " #[fg=colour39]#{pane_index} #[fg=colour51,bold]#{pane_title} "
tmux set-option -t "$session" -gq pane-border-style "fg=colour24"
tmux set-option -t "$session" -gq pane-active-border-style "fg=colour51,bold"
tmux set-option -t "$session" -gq message-style "bg=colour17,fg=colour51,bold"
tmux set-option -t "$session" -gq allow-rename off
tmux set-option -t "$session" -gq mouse on
tmux set-option -at "$session" -gq terminal-overrides ",xterm-256color:RGB,screen-256color:RGB,tmux-256color:RGB"

p1="$(tmux list-panes -t "$win_id" -F "#{pane_id}" | head -n1)"
p2="$(tmux split-window -h -P -F "#{pane_id}" -t "$p1" "TERM=tmux-256color COLORTERM=truecolor procs --watch --color always --theme dark")"
p3="$(tmux split-window -v -P -F "#{pane_id}" -t "$p1" "TERM=tmux-256color COLORTERM=truecolor watch -n 2 -c 'duf --theme ansi'")"
p4="$(tmux split-window -v -P -F "#{pane_id}" -t "$p2" "TERM=tmux-256color COLORTERM=truecolor watch -n 10 -c 'fastfetch --pipe false --bright-color true'")"
p5="$(tmux split-window -v -P -F "#{pane_id}" -t "$p3" "TERM=tmux-256color COLORTERM=truecolor cmatrix -ab -u 10")"
p6="$(tmux split-window -v -P -F "#{pane_id}" -t "$p4" "TERM=tmux-256color COLORTERM=truecolor FONDO_WIDGET_DURATION=16 /home/carlos/.local/bin/fondo-widget-runner")"

: "$p5" "$p6"

tmux select-pane -t "$p1" -T "BTop CPU/RAM"
tmux select-pane -t "$p2" -T "Processes"
tmux select-pane -t "$p3" -T "Disk Usage"
tmux select-pane -t "$p4" -T "System Profile"
tmux select-pane -t "$p5" -T "Matrix"
tmux select-pane -t "$p6" -T "Original Hollywood Widgets"

tmux select-layout -t "$win_id" tiled
tmux select-pane -t "$p1"

# Session-local shortcuts.
tmux bind-key -T prefix q kill-session -t "$session"
tmux bind-key -T prefix l next-layout -t "$win_id"
tmux bind-key -T prefix r rotate-window -t "$win_id" -D

if [[ "$motion" == "1" ]] && command -v /home/carlos/.local/bin/fondo-animate >/dev/null 2>&1; then
  tmux run-shell -b "/home/carlos/.local/bin/fondo-animate '$session' '$win_id' '$interval'"
fi

exec tmux attach -t "$session"
